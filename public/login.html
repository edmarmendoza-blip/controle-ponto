<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0E1625">
  <title>Login - Lar Digital</title>
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <link rel="stylesheet" href="/css/brand.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            graphite: '#0E1625',
            eucalyptus: '#697F71',
            porcelain: '#F7F4EE',
            mist: '#E7ECE8',
            sand: '#D8CCB8',
            indigo: '#7279F8',
            ink: '#1B2430',
            muted: '#667085',
            success: '#1F8F5F',
            warning: '#C98A2E',
            danger: '#B5473C',
            border: '#E8E4DE',
          },
          borderRadius: { sm: '8px', md: '12px', lg: '16px' },
          boxShadow: {
            sm: '0 1px 3px rgba(14,22,37,0.04)',
            md: '0 4px 16px rgba(14,22,37,0.06)',
            lg: '0 8px 40px rgba(14,22,37,0.08)',
          },
          fontFamily: { sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'] },
        }
      }
    }
  </script>
  <style>
    .hidden { display: none !important; }

    /* Spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
    .login-spinner {
      animation: spin 0.7s linear infinite;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: inline-block;
      flex-shrink: 0;
    }

    /* TOTP input */
    .totp-input {
      text-align: center;
      letter-spacing: 0.5em;
      font-family: monospace;
      font-size: 1.125rem;
    }

    /* Input focus ring using brand eucalyptus */
    .ld-login-input:focus {
      outline: none;
      border-color: #697F71;
      box-shadow: 0 0 0 3px rgba(105,127,113,0.15);
    }

    /* Password toggle hover */
    .toggle-pw-btn:hover { color: #697F71; }

    /* Login button success state */
    .btn-login-success {
      background-color: #1F8F5F !important;
    }

    /* Forgot section subtle bg */
    .forgot-section {
      background: rgba(247,244,238,0.8);
      border: 1px solid #E8E4DE;
      border-radius: 12px;
      padding: 1rem;
    }
  </style>
</head>
<body class="bg-porcelain min-h-screen flex flex-col items-center justify-center px-4 py-10 font-sans">

  <!-- Login Card -->
  <div class="w-full max-w-[400px]">
    <div class="bg-white rounded-lg shadow-lg p-8">

      <!-- Logo + Brand -->
      <div class="text-center mb-7">
        <div class="flex items-center justify-center gap-2.5 mb-3">
          <img src="/img/logo.svg" alt="Lar Digital" width="28" height="28" class="flex-shrink-0">
          <span class="text-xl font-bold text-ink tracking-tight">Lar Digital</span>
        </div>
        <p class="text-xs font-medium text-muted uppercase tracking-widest">Gestão da Casa</p>
      </div>

      <!-- Error Message -->
      <div id="errorDiv" class="hidden mb-4 flex items-start gap-2.5 bg-red-50 border border-red-200 text-danger rounded-md px-3.5 py-2.5 text-sm font-medium" role="alert">
        <i class="bi bi-exclamation-triangle-fill flex-shrink-0 mt-0.5"></i>
        <span id="errorMessage">Erro ao fazer login.</span>
      </div>

      <!-- Login Form -->
      <form id="loginForm" novalidate class="space-y-4">

        <!-- Email -->
        <div>
          <label for="email" class="block text-xs font-semibold text-ink mb-1.5">E-mail</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted pointer-events-none">
              <i class="bi bi-envelope-fill text-sm"></i>
            </span>
            <input type="email" id="email" name="email" required autocomplete="email"
              placeholder="seu.email@exemplo.com"
              class="ld-login-input w-full bg-porcelain border border-border rounded-sm pl-9 pr-3.5 py-2.5 text-sm text-ink placeholder-muted transition-colors duration-150">
          </div>
        </div>

        <!-- Password -->
        <div>
          <label for="password" class="block text-xs font-semibold text-ink mb-1.5">Senha</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted pointer-events-none">
              <i class="bi bi-lock-fill text-sm"></i>
            </span>
            <input type="password" id="password" name="password" required autocomplete="current-password"
              placeholder="Digite sua senha"
              class="ld-login-input w-full bg-porcelain border border-border rounded-sm pl-9 pr-10 py-2.5 text-sm text-ink placeholder-muted transition-colors duration-150">
            <button type="button" id="togglePassword" aria-label="Mostrar senha"
              class="toggle-pw-btn absolute right-3 top-1/2 -translate-y-1/2 text-muted bg-transparent border-none cursor-pointer transition-colors duration-150 p-0">
              <i class="bi bi-eye-fill text-base" id="eyeIcon"></i>
            </button>
          </div>
        </div>

        <!-- 2FA Token (hidden by default) -->
        <div id="totpField" class="hidden">
          <label for="totpToken" class="block text-xs font-semibold text-ink mb-1.5">Codigo 2FA</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted pointer-events-none">
              <i class="bi bi-shield-lock-fill text-sm"></i>
            </span>
            <input type="text" id="totpToken" name="totpToken" maxlength="6" pattern="[0-9]{6}"
              inputmode="numeric" autocomplete="one-time-code" placeholder="000000"
              class="ld-login-input totp-input w-full bg-porcelain border border-border rounded-sm pl-9 pr-3.5 py-2.5 text-ink placeholder-muted transition-colors duration-150">
          </div>
          <p class="mt-1.5 text-xs text-muted">
            <i class="bi bi-info-circle me-1"></i>
            Digite o codigo do seu aplicativo autenticador
          </p>
        </div>

        <!-- Login Button -->
        <button type="submit" id="loginBtn"
          class="w-full flex items-center justify-center gap-2 bg-graphite hover:bg-ink text-white text-sm font-semibold rounded-sm py-2.5 px-4 transition-all duration-150 disabled:opacity-60 disabled:cursor-not-allowed mt-2">
          <span id="btnText">Entrar</span>
          <span id="btnSpinner" class="hidden"><div class="login-spinner"></div></span>
          <i class="bi bi-arrow-right-short text-xl leading-none" id="btnIcon"></i>
        </button>

      </form>

      <!-- Forgot Password toggle -->
      <div class="text-center mt-4">
        <button type="button" id="forgotPasswordBtn"
          class="text-xs text-eucalyptus hover:text-ink font-medium transition-colors duration-150 underline-offset-2 hover:underline bg-transparent border-none cursor-pointer p-0">
          <i class="bi bi-key me-1"></i>Esqueci minha senha
        </button>
      </div>

      <!-- Forgot Password section -->
      <div id="forgotPasswordDiv" class="hidden mt-4">
        <div class="forgot-section">
          <!-- Step 1: Send code -->
          <div id="forgotStep1">
            <p class="text-xs text-muted mb-2.5">Digite seu e-mail para receber um codigo de recuperacao.</p>
            <div class="flex gap-2">
              <input type="email" id="forgotEmail" placeholder="seu@email.com"
                class="ld-login-input flex-1 bg-porcelain border border-border rounded-sm px-3 py-2 text-sm text-ink placeholder-muted transition-colors duration-150 min-w-0">
              <button type="button" onclick="sendForgotPassword()" id="sendResetBtn"
                class="flex-shrink-0 bg-graphite hover:bg-ink text-white text-xs font-semibold rounded-sm px-3 py-2 transition-colors duration-150 disabled:opacity-60 cursor-pointer border-none whitespace-nowrap">
                Enviar
              </button>
            </div>
          </div>
          <!-- Step 2: Enter code + new password -->
          <div id="forgotStep2" class="hidden">
            <p class="text-xs text-muted mb-2.5">Digite o codigo recebido por e-mail e sua nova senha.</p>
            <div class="flex flex-col gap-2">
              <input type="text" id="resetCode" placeholder="Codigo de 6 digitos" maxlength="6"
                class="ld-login-input totp-input bg-porcelain border border-border rounded-sm px-3 py-2 text-sm font-bold text-ink placeholder-muted transition-colors duration-150 w-full">
              <input type="password" id="resetNewPassword" placeholder="Nova senha (minimo 8 caracteres)"
                class="ld-login-input bg-porcelain border border-border rounded-sm px-3 py-2 text-sm text-ink placeholder-muted transition-colors duration-150 w-full">
              <button type="button" onclick="resetPassword()" id="resetPasswordBtn"
                class="w-full bg-success hover:opacity-90 text-white text-xs font-semibold rounded-sm py-2 px-3 transition-opacity duration-150 disabled:opacity-60 cursor-pointer border-none">
                Redefinir Senha
              </button>
            </div>
          </div>
          <div id="forgotMessage" class="hidden mt-2 text-xs"></div>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="mt-6 pt-5 border-t border-border text-center">
        <p class="text-xs text-muted">
          <i class="bi bi-shield-lock-fill me-1"></i>
          Acesso restrito a colaboradores autorizados
        </p>
      </div>

    </div><!-- /card -->

    <!-- Version + copyright -->
    <p class="text-center mt-4 text-xs text-muted">
      &copy; 2026 Lar Digital &mdash; Todos os direitos reservados
      <span id="login-version" class="ml-1"></span>
    </p>

  </div><!-- /max-w wrapper -->

  <script>
    // ==============================
    // Check if already logged in
    // ==============================
    (async function checkAuth() {
      const token = localStorage.getItem('ponto_token');
      if (!token) return;

      try {
        const res = await fetch('/api/auth/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          window.location.href = '/dashboard.html';
        } else {
          localStorage.removeItem('ponto_token');
        }
      } catch (e) {
        // Network error — stay on login page
      }
    })();

    // ==============================
    // Toggle Password Visibility
    // ==============================
    const togglePasswordBtn = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.getElementById('eyeIcon');

    togglePasswordBtn.addEventListener('click', function () {
      const isPassword = passwordInput.type === 'password';
      passwordInput.type = isPassword ? 'text' : 'password';
      eyeIcon.className = isPassword ? 'bi bi-eye-slash-fill text-base' : 'bi bi-eye-fill text-base';
      this.setAttribute('aria-label', isPassword ? 'Ocultar senha' : 'Mostrar senha');
    });

    // ==============================
    // Login Form Submission
    // ==============================
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const btnIcon = document.getElementById('btnIcon');
    const errorDiv = document.getElementById('errorDiv');
    const errorMessage = document.getElementById('errorMessage');

    function showError(message) {
      errorMessage.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      errorDiv.classList.add('hidden');
    }

    function setLoading(loading) {
      loginBtn.disabled = loading;
      if (loading) {
        btnText.textContent = 'Entrando...';
        btnSpinner.classList.remove('hidden');
        btnIcon.classList.add('hidden');
      } else {
        btnText.textContent = 'Entrar';
        btnSpinner.classList.add('hidden');
        btnIcon.classList.remove('hidden');
      }
    }

    loginForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      hideError();

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email) {
        showError('Por favor, informe seu e-mail.');
        document.getElementById('email').focus();
        return;
      }

      if (!password) {
        showError('Por favor, informe sua senha.');
        document.getElementById('password').focus();
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError('Por favor, informe um e-mail valido.');
        document.getElementById('email').focus();
        return;
      }

      setLoading(true);

      try {
        const body = { email, password };

        const totpField = document.getElementById('totpField');
        const totpInput = document.getElementById('totpToken');
        if (!totpField.classList.contains('hidden')) {
          const totpToken = totpInput.value.trim();
          if (!totpToken || totpToken.length !== 6) {
            showError('Digite o codigo de 6 digitos do seu autenticador.');
            totpInput.focus();
            setLoading(false);
            return;
          }
          body.totpToken = totpToken;
        }

        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();

        // Handle 2FA required response
        if (res.ok && data.requires2FA) {
          setLoading(false);
          totpField.classList.remove('hidden');
          totpInput.focus();
          errorDiv.classList.add('hidden');
          const infoDiv = document.createElement('div');
          infoDiv.id = 'info-2fa';
          infoDiv.className = 'flex items-center gap-2 bg-blue-50 border border-blue-200 text-blue-700 rounded-md px-3.5 py-2.5 text-sm font-medium mb-3';
          infoDiv.innerHTML = '<i class="bi bi-shield-lock-fill flex-shrink-0"></i><span>Autenticacao em dois fatores ativada. Digite o codigo do seu aplicativo.</span>';
          const existing = document.getElementById('info-2fa');
          if (existing) existing.remove();
          totpField.parentElement.insertBefore(infoDiv, totpField);
          return;
        }

        if (res.ok && data.token) {
          localStorage.setItem('ponto_token', data.token);
          localStorage.setItem('token', data.token);
          if (data.refreshToken) localStorage.setItem('ponto_refresh_token', data.refreshToken);

          btnText.textContent = 'Sucesso!';
          btnSpinner.classList.add('hidden');
          btnIcon.className = 'bi bi-check-lg text-xl leading-none';
          btnIcon.classList.remove('hidden');
          loginBtn.classList.add('btn-login-success');

          setTimeout(function () {
            window.location.href = '/dashboard.html';
          }, 500);
        } else {
          const message = data.message || data.error || 'E-mail ou senha incorretos.';
          showError(message);
          setLoading(false);
          if (!totpField.classList.contains('hidden')) {
            totpInput.focus();
          } else {
            document.getElementById('password').focus();
          }
        }
      } catch (err) {
        showError('Erro de conexao. Verifique sua internet e tente novamente.');
        setLoading(false);
      }
    });

    // Hide error when user starts typing
    document.getElementById('email').addEventListener('input', hideError);
    document.getElementById('password').addEventListener('input', hideError);
    document.getElementById('totpToken').addEventListener('input', hideError);

    // Forgot Password
    document.getElementById('forgotPasswordBtn').addEventListener('click', function () {
      const div = document.getElementById('forgotPasswordDiv');
      div.classList.toggle('hidden');
      if (!div.classList.contains('hidden')) {
        const emailVal = document.getElementById('email').value;
        if (emailVal) document.getElementById('forgotEmail').value = emailVal;
        document.getElementById('forgotEmail').focus();
      }
    });

    async function sendForgotPassword() {
      const email = document.getElementById('forgotEmail').value.trim();
      const msgDiv = document.getElementById('forgotMessage');
      const btn = document.getElementById('sendResetBtn');
      if (!email) { msgDiv.className = 'mt-2 text-xs text-danger'; msgDiv.textContent = 'Informe seu e-mail.'; msgDiv.classList.remove('hidden'); return; }
      btn.disabled = true; btn.textContent = 'Enviando...';
      try {
        const res = await fetch('/api/auth/forgot-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
        const data = await res.json();
        msgDiv.className = 'mt-2 text-xs text-success';
        msgDiv.innerHTML = '<i class="bi bi-check-circle me-1"></i>' + (data.message || 'Verifique seu e-mail.');
        msgDiv.classList.remove('hidden');
        document.getElementById('forgotStep1').classList.add('hidden');
        document.getElementById('forgotStep2').classList.remove('hidden');
        document.getElementById('resetCode').focus();
      } catch (err) { msgDiv.className = 'mt-2 text-xs text-danger'; msgDiv.textContent = 'Erro ao enviar.'; msgDiv.classList.remove('hidden'); }
      finally { btn.disabled = false; btn.textContent = 'Enviar'; }
    }

    async function resetPassword() {
      const email = document.getElementById('forgotEmail').value.trim();
      const code = document.getElementById('resetCode').value.trim();
      const newPassword = document.getElementById('resetNewPassword').value;
      const msgDiv = document.getElementById('forgotMessage');
      const btn = document.getElementById('resetPasswordBtn');
      if (!code || code.length !== 6) { msgDiv.className = 'mt-2 text-xs text-danger'; msgDiv.textContent = 'Digite o codigo de 6 digitos.'; msgDiv.classList.remove('hidden'); return; }
      if (!newPassword || newPassword.length < 8) { msgDiv.className = 'mt-2 text-xs text-danger'; msgDiv.textContent = 'A nova senha deve ter pelo menos 8 caracteres.'; msgDiv.classList.remove('hidden'); return; }
      btn.disabled = true; btn.textContent = 'Redefinindo...';
      try {
        const res = await fetch('/api/auth/reset-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, code, newPassword }) });
        const data = await res.json();
        if (res.ok) {
          msgDiv.className = 'mt-2 text-xs text-success';
          msgDiv.innerHTML = '<i class="bi bi-check-circle me-1"></i>' + data.message;
          setTimeout(() => { document.getElementById('forgotPasswordDiv').classList.add('hidden'); document.getElementById('forgotStep1').classList.remove('hidden'); document.getElementById('forgotStep2').classList.add('hidden'); }, 3000);
        } else {
          msgDiv.className = 'mt-2 text-xs text-danger';
          msgDiv.textContent = data.error || 'Erro ao redefinir senha.';
        }
        msgDiv.classList.remove('hidden');
      } catch (err) { msgDiv.className = 'mt-2 text-xs text-danger'; msgDiv.textContent = 'Erro ao redefinir.'; msgDiv.classList.remove('hidden'); }
      finally { btn.disabled = false; btn.textContent = 'Redefinir Senha'; }
    }

    // Load version
    fetch('/api/version').then(r => r.json()).then(v => {
      const el = document.getElementById('login-version');
      if (el && v.version) {
        const envLabel = v.env ? v.env.charAt(0).toUpperCase() + v.env.slice(1) : '';
        const dateLabel = v.date ? v.date.split('-').reverse().join('/') : '';
        el.textContent = 'v' + v.version + (envLabel ? ' | ' + envLabel : '') + (dateLabel ? ' | ' + dateLabel : '');
      }
    }).catch(() => {});
  </script>
</body>
</html>
