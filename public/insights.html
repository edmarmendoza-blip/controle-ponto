<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insights IA - Lar Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { primary: { DEFAULT: '#1e40af', light: '#3b82f6', dark: '#1e3a8a' } } } }
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen bg-blue-800 text-white transition-transform -translate-x-full md:translate-x-0">
    <div class="p-4 border-b border-blue-700">
      <a href="/dashboard.html" class="flex items-center gap-2">
        <i class="bi bi-clock-history text-2xl"></i>
        <span class="text-xl font-bold">Lar Digital</span>
      </a>
      <p class="text-blue-200 text-xs mt-1">Gestão da Casa</p>
    </div>
    <nav class="p-3 space-y-1 overflow-y-auto h-[calc(100vh-180px)]">
      <a href="/dashboard.html" data-page="dashboard" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors">
        <i class="bi bi-speedometer2"></i><span>Dashboard</span>
      </a>
      <a href="/funcionarios.html" data-page="funcionarios" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors">
        <i class="bi bi-people"></i><span>Funcionários</span>
      </a>
      <a href="/registros.html" data-page="registros" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors">
        <i class="bi bi-clock"></i><span>Registros</span>
      </a>
      <a href="/relatorios.html" data-page="relatorios" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors">
        <i class="bi bi-file-earmark-text"></i><span>Relatórios</span>
      </a>
      <a href="/relatorios-graficos.html" data-page="relatorios-graficos" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors">
        <i class="bi bi-bar-chart-line"></i><span>Gráficos</span>
      </a>
      <a href="/presenca.html" data-page="presenca" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors">
        <i class="bi bi-calendar-check"></i><span>Presença</span>
      </a>
      <a href="/entregas.html" data-page="entregas" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-box-seam"></i><span>Entregas</span>
      </a>
      <a href="/holerites.html" data-page="holerites" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-receipt"></i><span>Holerites</span>
      </a>
      <a href="/ferias.html" data-page="ferias" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-calendar-heart"></i><span>Férias</span>
      </a>
      <a href="/usuarios.html" data-page="usuarios" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-shield-lock"></i><span>Usuários</span>
      </a>
      <a href="/feriados.html" data-page="feriados" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-calendar-event"></i><span>Feriados</span>
      </a>
      <a href="/insights.html" data-page="insights" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-stars"></i><span>Insights IA</span>
      </a>
      <a href="/whatsapp.html" data-page="whatsapp" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-whatsapp"></i><span>WhatsApp</span>
      </a>
      <a href="/audit-log.html" data-page="audit-log" class="flex items-center gap-3 px-3 py-2 rounded-lg text-blue-100 hover:bg-blue-700/50 transition-colors admin-only hidden">
        <i class="bi bi-journal-text"></i><span>Audit Log</span>
      </a>
    </nav>
    <div class="absolute bottom-0 left-0 right-0 p-3 border-t border-blue-700 bg-blue-800">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2 text-sm">
          <i class="bi bi-person-circle"></i>
          <div>
            <div id="user-name" class="font-medium">-</div>
            <div id="user-role" class="text-blue-300 text-xs">-</div>
          </div>
        </div>
        <button id="theme-toggle" class="p-1.5 rounded-lg hover:bg-blue-700 transition-colors">
          <i id="theme-icon" class="bi bi-moon-fill"></i>
        </button>
      </div>
      <button id="logout-btn" class="w-full py-1.5 text-sm bg-blue-700 hover:bg-blue-600 rounded-lg transition-colors">Sair</button>
    </div>
  </aside>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

  <!-- Main Content -->
  <main class="md:ml-64 min-h-screen">
    <header class="bg-white dark:bg-gray-800 shadow-sm p-4 flex items-center justify-between sticky top-0 z-20">
      <div class="flex items-center gap-3">
        <button id="sidebar-toggle" class="md:hidden text-gray-600 dark:text-gray-300">
          <i class="bi bi-list text-xl"></i>
        </button>
        <h1 class="text-xl font-semibold">Insights IA</h1>
      </div>
      <span class="text-sm text-gray-500 dark:text-gray-400" id="current-date"></span>
    </header>

    <div class="p-4 md:p-6" id="page-content">
      <!-- Action Bar -->
      <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
            <i class="bi bi-stars text-purple-600 dark:text-purple-400 text-lg"></i>
          </div>
          <div>
            <h2 class="text-lg font-semibold">Analise Inteligente</h2>
            <p class="text-xs text-gray-500 dark:text-gray-400">Insights gerados por IA sobre a equipe</p>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <button onclick="generateDaily()" id="btn-daily" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors text-sm font-medium">
            <i class="bi bi-lightning-charge-fill mr-1"></i>
            Gerar Insight Diario
          </button>
          <button onclick="showPeriodModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium">
            <i class="bi bi-calendar-range mr-1"></i>
            Gerar por Periodo
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Total de Insights</p>
              <p class="text-3xl font-bold mt-1" id="stat-total">0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center">
              <i class="bi bi-stars text-xl text-purple-600 dark:text-purple-400"></i>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Mensagens Analisadas</p>
              <p class="text-3xl font-bold mt-1 text-blue-600 dark:text-blue-400" id="stat-messages">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center">
              <i class="bi bi-chat-square-text text-xl text-blue-600 dark:text-blue-400"></i>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Ultimo Insight</p>
              <p class="text-3xl font-bold mt-1 text-green-600 dark:text-green-400" id="stat-latest">-</p>
            </div>
            <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center">
              <i class="bi bi-calendar-check text-xl text-green-600 dark:text-green-400"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Insights List -->
      <div id="insights-list" class="space-y-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-8 text-center">
          <i class="bi bi-arrow-repeat animate-spin text-2xl text-gray-400"></i>
          <p class="mt-2 text-sm text-gray-400">Carregando insights...</p>
        </div>
      </div>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-6" id="pagination-area">
        <span class="text-sm text-gray-500 dark:text-gray-400" id="page-info"></span>
        <div class="flex gap-2">
          <button onclick="prevPage()" id="btn-prev" class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="bi bi-chevron-left mr-1"></i> Anterior
          </button>
          <button onclick="nextPage()" id="btn-next" class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Proximo <i class="bi bi-chevron-right ml-1"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Period Modal -->
  <div id="period-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full">
      <div class="flex items-center justify-between p-5 border-b border-gray-100 dark:border-gray-700">
        <h3 class="text-lg font-semibold">Gerar Insights por Periodo</h3>
        <button onclick="closePeriodModal()" class="w-8 h-8 rounded-lg bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="p-5 space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Inicio</label>
            <input type="date" id="period-start" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-sm focus:ring-2 focus:ring-primary focus:border-primary">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Fim</label>
            <input type="date" id="period-end" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-sm focus:ring-2 focus:ring-primary focus:border-primary">
          </div>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          <i class="bi bi-info-circle mr-1"></i>
          A IA analisara todos os registros e mensagens do periodo selecionado.
        </p>
      </div>
      <div class="flex justify-end gap-3 p-5 border-t border-gray-100 dark:border-gray-700">
        <button onclick="closePeriodModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium">Cancelar</button>
        <button onclick="generatePeriod()" id="btn-gen-period" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors text-sm font-medium">
          <i class="bi bi-stars mr-1"></i> Gerar
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

  <script src="/js/shared.js"></script>
  <script>
    let currentPage = 1;
    let totalPages = 1;

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadInsights(page) {
      currentPage = page || 1;
      const list = document.getElementById('insights-list');
      list.innerHTML = '<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-8 text-center"><i class="bi bi-arrow-repeat animate-spin text-2xl text-gray-400"></i><p class="mt-2 text-sm text-gray-400">Carregando...</p></div>';

      try {
        const data = await Shared.api(`/api/insights?page=${currentPage}&limit=10`);
        const insights = data.insights || [];
        const total = data.total || 0;
        totalPages = data.pages || 1;

        document.getElementById('stat-total').textContent = total;

        let totalMsgs = 0;
        insights.forEach(i => { totalMsgs += (i.mensagens_analisadas || 0); });
        document.getElementById('stat-messages').textContent = totalMsgs;

        if (insights.length > 0) {
          const latest = insights[0];
          document.getElementById('stat-latest').textContent = Shared.formatDate(latest.data);
        }

        if (insights.length === 0) {
          list.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-12 text-center">
              <div class="w-16 h-16 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mx-auto mb-4">
                <i class="bi bi-stars text-3xl text-purple-400"></i>
              </div>
              <p class="font-medium text-gray-500 dark:text-gray-400">Nenhum insight gerado ainda</p>
              <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Clique em "Gerar Insight Diario" para comecar.</p>
            </div>`;
          updatePagination();
          return;
        }

        list.innerHTML = insights.map(insight => {
          const dt = insight.created_at ? new Date(insight.created_at) : null;
          const dateStr = dt ? dt.toLocaleDateString('pt-BR') + ' ' + dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '-';
          let insightData;
          try {
            insightData = typeof insight.insights_json === 'string' ? JSON.parse(insight.insights_json) : insight.insights_json;
          } catch (e) {
            insightData = { resumo: insight.insights_json || 'Sem dados' };
          }

          const resumo = insightData.resumo || insightData.summary || (typeof insightData === 'string' ? insightData : JSON.stringify(insightData).substring(0, 300));

          return `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
              <div class="p-5">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                      <i class="bi bi-stars text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div>
                      <h3 class="font-semibold">${Shared.formatDate(insight.data)}</h3>
                      <p class="text-xs text-gray-500 dark:text-gray-400">${insight.mensagens_analisadas || 0} mensagens analisadas &bull; ${insight.modelo || 'claude'}</p>
                    </div>
                  </div>
                  <span class="text-xs text-gray-400">${dateStr}</span>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-wrap leading-relaxed">${escapeHtml(typeof resumo === 'string' ? resumo : JSON.stringify(resumo, null, 2))}</div>
              </div>
            </div>`;
        }).join('');

        updatePagination();
      } catch (err) {
        list.innerHTML = `
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-8 text-center">
            <i class="bi bi-exclamation-circle text-3xl text-red-400 mb-3"></i>
            <p class="text-red-500">${err.message}</p>
          </div>`;
      }
    }

    function updatePagination() {
      document.getElementById('page-info').textContent = `Pagina ${currentPage} de ${totalPages}`;
      document.getElementById('btn-prev').disabled = currentPage <= 1;
      document.getElementById('btn-next').disabled = currentPage >= totalPages;
    }

    function prevPage() { if (currentPage > 1) loadInsights(currentPage - 1); }
    function nextPage() { if (currentPage < totalPages) loadInsights(currentPage + 1); }

    async function generateDaily() {
      const btn = document.getElementById('btn-daily');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin mr-1"></i> Gerando...';

      try {
        const today = new Date().toISOString().split('T')[0];
        await Shared.api('/api/insights/generate', {
          method: 'POST',
          body: JSON.stringify({ date: today })
        });
        showToast('Insight diario gerado com sucesso!');
        await loadInsights(1);
      } catch (err) {
        showToast('Erro: ' + err.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightning-charge-fill mr-1"></i> Gerar Insight Diario';
      }
    }

    function showPeriodModal() {
      const today = new Date().toISOString().split('T')[0];
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      document.getElementById('period-start').value = thirtyDaysAgo;
      document.getElementById('period-end').value = today;
      document.getElementById('period-modal').classList.remove('hidden');
    }

    function closePeriodModal() {
      document.getElementById('period-modal').classList.add('hidden');
    }

    async function generatePeriod() {
      const startDate = document.getElementById('period-start').value;
      const endDate = document.getElementById('period-end').value;
      if (!startDate || !endDate) {
        showToast('Preencha as datas.', 'warning');
        return;
      }

      const btn = document.getElementById('btn-gen-period');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin mr-1"></i> Gerando...';

      try {
        await Shared.api('/api/insights/generate-period', {
          method: 'POST',
          body: JSON.stringify({ startDate, endDate })
        });
        showToast('Insights do periodo gerados com sucesso!');
        closePeriodModal();
        await loadInsights(1);
      } catch (err) {
        showToast('Erro: ' + err.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-stars mr-1"></i> Gerar';
      }
    }

    window.onAuthReady = function(user) {
      if (user.role !== 'admin') {
        window.location.href = '/dashboard.html';
        return;
      }
      loadInsights(1);
    };
  </script>
</body>
</html>
