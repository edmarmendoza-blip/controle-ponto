<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0E1625">
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <title>Meu Perfil - Lar Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            graphite: '#0E1625', eucalyptus: '#697F71', porcelain: '#F7F4EE',
            mist: '#E7ECE8', sand: '#D8CCB8', indigo: '#7279F8', ink: '#1B2430',
            muted: '#667085', success: '#1F8F5F', warning: '#C98A2E',
            danger: '#B5473C', border: '#E8E4DE'
          },
          borderRadius: { sm: '8px', md: '12px', lg: '16px' },
          boxShadow: {
            sm: '0 1px 3px rgba(14,22,37,0.04)',
            md: '0 4px 16px rgba(14,22,37,0.06)',
            lg: '0 8px 40px rgba(14,22,37,0.08)'
          },
          fontFamily: { sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'] }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/css/brand.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
</head>
<body class="bg-porcelain text-ink">

  <!-- Sidebar -->
  <aside id="sidebar" class="ld-sidebar"></aside>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-30 hidden md:hidden"></div>

  <!-- Main Content -->
  <main class="ld-content min-h-screen">
    <header class="ld-header bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-20">
      <div class="flex items-center gap-3">
        <button id="sidebar-toggle" class="md:hidden text-muted hover:text-ink transition-colors">
          <i class="bi bi-list text-xl"></i>
        </button>
        <h1 class="text-xl font-semibold">Meu Perfil</h1>
      </div>
      <span class="text-sm text-muted" id="current-date"></span>
    </header>

    <div class="p-4 md:p-6" id="page-content">
      <div class="max-w-2xl mx-auto space-y-6">

        <!-- User Info Card -->
        <div class="bg-white rounded-xl shadow-sm border border-border">
          <div class="p-5 border-b border-border">
            <h2 class="text-lg font-semibold flex items-center gap-2">
              <i class="bi bi-person-circle text-eucalyptus"></i>
              Informações do Usuário
            </h2>
          </div>
          <div class="p-5 space-y-4">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full bg-mist flex items-center justify-center">
                <i class="bi bi-person-fill text-3xl text-eucalyptus"></i>
              </div>
              <div>
                <p class="text-xl font-semibold" id="profile-name">-</p>
                <p class="text-sm text-muted" id="profile-email">-</p>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-mist text-eucalyptus mt-1" id="profile-role">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Password Change Card -->
        <div class="bg-white rounded-xl shadow-sm border border-border">
          <div class="p-5 border-b border-border">
            <h2 class="text-lg font-semibold flex items-center gap-2">
              <i class="bi bi-key text-warning"></i>
              Alterar Senha
            </h2>
          </div>
          <div class="p-5">
            <form id="password-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1" for="current-password">Senha Atual</label>
                <input type="password" id="current-password" class="w-full border border-border rounded-lg px-3 py-2 bg-white text-sm focus:ring-2 focus:ring-eucalyptus focus:border-eucalyptus" required>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="new-password">Nova Senha</label>
                <input type="password" id="new-password" class="w-full border border-border rounded-lg px-3 py-2 bg-white text-sm focus:ring-2 focus:ring-eucalyptus focus:border-eucalyptus" required minlength="8">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1" for="confirm-password">Confirmar Nova Senha</label>
                <input type="password" id="confirm-password" class="w-full border border-border rounded-lg px-3 py-2 bg-white text-sm focus:ring-2 focus:ring-eucalyptus focus:border-eucalyptus" required minlength="8">
              </div>
              <div class="flex justify-end">
                <button type="submit" class="px-4 py-2 bg-graphite text-white rounded-lg hover:bg-graphite/90 transition-colors text-sm font-medium">
                  <i class="bi bi-check-lg mr-1"></i> Alterar Senha
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- 2FA Card -->
        <div class="bg-white rounded-xl shadow-sm border border-border">
          <div class="p-5 border-b border-border">
            <h2 class="text-lg font-semibold flex items-center gap-2">
              <i class="bi bi-shield-lock text-success"></i>
              Autenticação em Dois Fatores (2FA)
            </h2>
          </div>
          <div class="p-5" id="twofa-section">
            <!-- 2FA Status: loading -->
            <div id="twofa-loading" class="flex items-center justify-center py-8">
              <i class="bi bi-arrow-repeat animate-spin text-2xl text-muted"></i>
              <span class="ml-2 text-muted">Carregando status...</span>
            </div>

            <!-- 2FA Status: enabled -->
            <div id="twofa-enabled" class="hidden">
              <div class="flex items-center gap-3 p-4 bg-mist rounded-lg mb-4">
                <i class="bi bi-shield-fill-check text-2xl text-success"></i>
                <div>
                  <p class="font-medium text-success">2FA Ativado</p>
                  <p class="text-sm text-muted">Sua conta está protegida com autenticação em dois fatores.</p>
                </div>
              </div>
              <button onclick="disable2FA()" id="btn-disable-2fa" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-danger/90 transition-colors text-sm font-medium">
                <i class="bi bi-shield-x mr-1"></i> Desativar 2FA
              </button>
            </div>

            <!-- 2FA Status: disabled -->
            <div id="twofa-disabled" class="hidden">
              <div class="flex items-center gap-3 p-4 bg-amber-50 rounded-lg mb-4">
                <i class="bi bi-shield-exclamation text-2xl text-warning"></i>
                <div>
                  <p class="font-medium text-warning">2FA Desativado</p>
                  <p class="text-sm text-muted">Ative a autenticação em dois fatores para maior segurança.</p>
                </div>
              </div>
              <button onclick="setup2FA()" id="btn-setup-2fa" class="px-4 py-2 bg-success text-white rounded-lg hover:bg-success/90 transition-colors text-sm font-medium">
                <i class="bi bi-shield-plus mr-1"></i> Ativar 2FA
              </button>
            </div>

            <!-- 2FA Setup: QR code + verify -->
            <div id="twofa-setup" class="hidden">
              <div class="text-center mb-4">
                <p class="text-sm text-muted mb-3">Escaneie o QR Code abaixo com seu aplicativo autenticador (Google Authenticator, Authy, etc):</p>
                <div class="inline-block p-4 bg-white rounded-xl shadow-sm border border-border">
                  <img id="twofa-qr" src="" alt="QR Code" class="w-48 h-48">
                </div>
                <p class="text-xs text-muted mt-2">Ou insira manualmente: <code id="twofa-secret" class="bg-mist px-2 py-1 rounded text-xs">-</code></p>
              </div>
              <div class="max-w-xs mx-auto">
                <label class="block text-sm font-medium mb-1">Código de Verificação</label>
                <div class="flex gap-2">
                  <input type="text" id="twofa-code" class="flex-1 border border-border rounded-lg px-3 py-2 bg-white text-sm text-center tracking-widest font-mono focus:ring-2 focus:ring-eucalyptus focus:border-eucalyptus" placeholder="000000" maxlength="6" inputmode="numeric">
                  <button onclick="verify2FA()" id="btn-verify-2fa" class="px-4 py-2 bg-graphite text-white rounded-lg hover:bg-graphite/90 transition-colors text-sm font-medium">
                    Verificar
                  </button>
                </div>
              </div>
              <div class="text-center mt-3">
                <button onclick="cancelSetup()" class="text-sm text-muted hover:text-ink">Cancelar</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

  <script src="/js/utils.js?v=1"></script>
  <script src="/js/shared.js"></script>
  <script>
    let twofaSecret = null;

    function loadProfile(user) {
      document.getElementById('profile-name').textContent = user.name || '-';
      document.getElementById('profile-email').textContent = user.email || '-';
      const roleMap = { admin: 'Administrador', gestor: 'Gestor', viewer: 'Visualizador' };
      document.getElementById('profile-role').textContent = roleMap[user.role] || user.role;
    }

    async function load2FAStatus() {
      document.getElementById('twofa-loading').classList.remove('hidden');
      document.getElementById('twofa-enabled').classList.add('hidden');
      document.getElementById('twofa-disabled').classList.add('hidden');
      document.getElementById('twofa-setup').classList.add('hidden');

      try {
        const data = await Shared.api('/api/auth/2fa/status');
        document.getElementById('twofa-loading').classList.add('hidden');
        if (data.enabled) {
          document.getElementById('twofa-enabled').classList.remove('hidden');
        } else {
          document.getElementById('twofa-disabled').classList.remove('hidden');
        }
      } catch (err) {
        document.getElementById('twofa-loading').classList.add('hidden');
        document.getElementById('twofa-disabled').classList.remove('hidden');
      }
    }

    // Password change
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        showToast('As senhas não conferem.', 'warning');
        return;
      }
      if (newPassword.length < 6) {
        showToast('A nova senha deve ter pelo menos 6 caracteres.', 'warning');
        return;
      }

      try {
        await Shared.api('/api/auth/password', {
          method: 'PUT',
          body: JSON.stringify({ currentPassword, newPassword })
        });
        showToast('Senha alterada com sucesso!');
        this.reset();
      } catch (err) {
        showToast('Erro: ' + err.message, 'danger');
      }
    });

    async function setup2FA() {
      const btn = document.getElementById('btn-setup-2fa');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin mr-1"></i> Configurando...';

      try {
        const data = await Shared.api('/api/auth/2fa/setup', { method: 'POST' });
        twofaSecret = data.secret;
        document.getElementById('twofa-qr').src = data.qrCode || data.qr || '';
        document.getElementById('twofa-secret').textContent = data.secret || '-';

        document.getElementById('twofa-disabled').classList.add('hidden');
        document.getElementById('twofa-setup').classList.remove('hidden');
      } catch (err) {
        showToast('Erro: ' + err.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-shield-plus mr-1"></i> Ativar 2FA';
      }
    }

    async function verify2FA() {
      const code = document.getElementById('twofa-code').value.trim();
      if (!code || code.length !== 6) {
        showToast('Insira o código de 6 dígitos.', 'warning');
        return;
      }

      const btn = document.getElementById('btn-verify-2fa');
      btn.disabled = true;

      try {
        await Shared.api('/api/auth/2fa/verify', {
          method: 'POST',
          body: JSON.stringify({ token: code, secret: twofaSecret })
        });
        showToast('2FA ativado com sucesso!');
        document.getElementById('twofa-setup').classList.add('hidden');
        document.getElementById('twofa-enabled').classList.remove('hidden');
      } catch (err) {
        showToast('Erro: ' + err.message, 'danger');
      } finally {
        btn.disabled = false;
      }
    }

    function cancelSetup() {
      document.getElementById('twofa-setup').classList.add('hidden');
      document.getElementById('twofa-disabled').classList.remove('hidden');
      twofaSecret = null;
    }

    async function disable2FA() {
      Shared.showConfirmModal('Deseja realmente desativar a autenticação em dois fatores?', async () => {
        const btn = document.getElementById('btn-disable-2fa');
        btn.disabled = true;

        try {
          await Shared.api('/api/auth/2fa', { method: 'DELETE' });
          showToast('2FA desativado.');
          document.getElementById('twofa-enabled').classList.add('hidden');
          document.getElementById('twofa-disabled').classList.remove('hidden');
        } catch (err) {
          showToast('Erro: ' + err.message, 'danger');
        } finally {
          btn.disabled = false;
        }
      });
    }

    window.onAuthReady = function(user) {
      loadProfile(user);
      load2FAStatus();
    };
  </script>
</body>
</html>
