<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
  <meta name="theme-color" content="#0E1625">
  <title>Registro de Entregas - Lar Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            graphite: '#0E1625', eucalyptus: '#697F71', porcelain: '#F7F4EE',
            mist: '#E7ECE8', sand: '#D8CCB8', indigo: '#7279F8', ink: '#1B2430',
            muted: '#667085', success: '#1F8F5F', warning: '#C98A2E',
            danger: '#B5473C', border: '#E8E4DE'
          },
          borderRadius: { sm: '8px', md: '12px', lg: '16px' },
          boxShadow: { card: '0 1px 4px rgba(27,36,48,0.08)' },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/css/brand.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
</head>
<body class="bg-porcelain text-ink">

  <aside id="sidebar" class="ld-sidebar"></aside>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-30 hidden md:hidden"></div>

  <!-- Main Content -->
  <main class="ld-content min-h-screen">
    <header class="ld-header">
      <div class="flex items-center gap-3">
        <button id="sidebar-toggle" class="md:hidden text-muted hover:text-ink transition-colors"><i class="bi bi-list text-xl"></i></button>
        <h1>Registro de Entregas</h1>
      </div>
      <span class="text-sm text-muted" id="current-date"></span>
    </header>
    <div class="p-4 md:p-6" id="page-content">

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">Fotos Hoje</p>
              <p class="text-3xl font-bold mt-1 text-blue-600" id="stat-today">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
              <i class="bi bi-camera-fill text-xl text-blue-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">Total no Período</p>
              <p class="text-3xl font-bold mt-1 text-green-600" id="stat-total">0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
              <i class="bi bi-images text-xl text-green-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">Mensagens com Texto</p>
              <p class="text-3xl font-bold mt-1 text-purple-600" id="stat-with-text">0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
              <i class="bi bi-chat-text-fill text-xl text-purple-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Info Card -->
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
            <i class="bi bi-camera-fill text-blue-600 text-lg"></i>
          </div>
          <div>
            <h3 class="font-medium text-blue-800">Registros de fotos e mídias</h3>
            <p class="text-sm text-blue-600 mt-1">Fotos e mídias enviadas no grupo WhatsApp são salvas automaticamente. Use os filtros para buscar por data e funcionário.</p>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
        <div class="flex flex-wrap items-end gap-4">
          <div>
            <label class="block text-sm font-medium mb-1" for="filter-date">Data</label>
            <input type="date" id="filter-date"
              class="px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-colors text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="filter-employee">Funcionário</label>
            <select id="filter-employee"
              class="px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-colors text-sm min-w-[200px]">
              <option value="">Todos</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="filter-type">Tipo</label>
            <select id="filter-type"
              class="px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-colors text-sm">
              <option value="">Todos</option>
              <option value="image">Fotos</option>
              <option value="video">Vídeos</option>
              <option value="audio">Áudios</option>
            </select>
          </div>
          <button onclick="loadEntregas()" class="flex items-center gap-2 px-4 py-2 bg-graphite hover:bg-graphite/90 text-white rounded-lg transition-colors text-sm">
            <i class="bi bi-search"></i>
            <span>Filtrar</span>
          </button>
        </div>
      </div>

      <!-- Gallery View -->
      <div id="entregas-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="col-span-full text-center py-12 text-gray-400">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="bi bi-box-seam text-3xl text-gray-400"></i>
          </div>
          <p class="text-lg font-medium text-gray-500">Carregando...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onclick="closeLightbox(event)">
    <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white/80 hover:text-white text-2xl z-10">
      <i class="bi bi-x-lg"></i>
    </button>
    <div class="max-w-4xl max-h-[90vh] flex flex-col items-center">
      <img id="lightbox-img" src="" alt="" class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl">
      <div class="mt-3 text-white/80 text-sm text-center" id="lightbox-caption"></div>
    </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>
  <script src="/js/utils.js?v=1"></script>
  <script src="/js/shared.js"></script>
  <script>
    document.getElementById('filter-date').value = (() => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; })();

    async function loadEmployees() {
      try {
        const data = await Shared.api('/api/funcionarios');
        const employees = Array.isArray(data) ? data : (data.funcionarios || []);
        const select = document.getElementById('filter-employee');
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.nome;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Erro ao carregar funcionários:', err);
      }
    }

    async function loadEntregas() {
      const date = document.getElementById('filter-date').value;
      const empId = document.getElementById('filter-employee').value;
      const mediaType = document.getElementById('filter-type').value;
      const gallery = document.getElementById('entregas-gallery');

      gallery.innerHTML = `
        <div class="col-span-full text-center py-12 text-gray-400">
          <i class="bi bi-arrow-repeat animate-spin text-3xl"></i>
          <p class="mt-2">Carregando entregas...</p>
        </div>`;

      try {
        let url = `/api/whatsapp/messages?date=${date}&media_only=true`;
        if (empId) url += `&funcionario_id=${empId}`;
        if (mediaType) url += `&media_type=${mediaType}`;

        const data = await Shared.api(url);
        const messages = Array.isArray(data) ? data : (data.messages || []);

        // Update stats
        const todayStr = (() => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; })();
        const todayMsgs = messages.filter(m => (m.created_at || '').startsWith(todayStr));
        const withText = messages.filter(m => m.message_text && m.message_text !== '<Mídia oculta>');

        document.getElementById('stat-today').textContent = todayMsgs.length;
        document.getElementById('stat-total').textContent = messages.length;
        document.getElementById('stat-with-text').textContent = withText.length;

        if (messages.length === 0) {
          gallery.innerHTML = `
            <div class="col-span-full text-center py-12 text-gray-400">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="bi bi-camera text-3xl text-gray-400"></i>
              </div>
              <p class="text-lg font-medium text-gray-500">Nenhuma mídia encontrada</p>
              <p class="text-sm mt-1">Tente outra data ou remova os filtros.</p>
            </div>`;
          return;
        }

        gallery.innerHTML = messages.map(m => {
          const time = (m.created_at || '').split(' ')[1] || '';
          const timeStr = time ? time.substring(0, 5) : '';
          const dateStr = (m.created_at || '').split(' ')[0] || '';
          const sender = m.funcionario_nome || m.sender_name || 'Desconhecido';
          const rawText = m.message_text && m.message_text !== '<Mídia oculta>' ? m.message_text : '';
          const isImage = m.media_type === 'image' && m.media_path;

          // Extract AI analysis if present
          const aiMatch = rawText.match(/\[Análise IA\]:\s*(.*)/s);
          const aiText = aiMatch ? aiMatch[1].trim() : '';
          const userText = rawText.replace(/\n?\n?\[Análise IA\]:.*$/s, '').trim();

          const mediaBadge = m.media_type === 'image' ? '<i class="bi bi-image text-blue-500"></i>'
            : m.media_type === 'video' ? '<i class="bi bi-camera-video text-red-500"></i>'
            : m.media_type === 'audio' ? '<i class="bi bi-mic text-green-500"></i>'
            : '<i class="bi bi-file-earmark text-gray-500"></i>';

          const escapedSender = sender.replace(/'/g, "\\'");
          return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
              ${isImage ? `
                <div class="relative cursor-pointer group" onclick="openLightbox('${m.media_path}', '${escapedSender} - ${dateStr} ${timeStr}')">
                  <img src="${m.media_path}" alt="Foto de ${sender}" class="w-full h-52 object-cover" loading="lazy">
                  <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                    <i class="bi bi-zoom-in text-white text-2xl opacity-0 group-hover:opacity-100 transition-opacity"></i>
                  </div>
                  <div class="absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded-full">${timeStr}</div>
                </div>
              ` : `
                <div class="w-full h-52 bg-gray-100 flex items-center justify-center">
                  <div class="text-center">
                    <div class="text-4xl mb-2">${mediaBadge}</div>
                    <span class="text-sm text-gray-500">${m.media_type || 'mídia'}</span>
                  </div>
                </div>
              `}
              <div class="p-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                      <i class="bi bi-person-fill text-blue-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-medium">${sender}</span>
                  </div>
                  <span class="text-xs text-gray-400">${dateStr}</span>
                </div>
                ${userText ? `<p class="text-xs text-gray-600 mb-2">${userText}</p>` : ''}
                ${aiText ? `
                  <div class="p-2 bg-purple-50 rounded-lg border border-purple-100 mb-2">
                    <p class="text-xs text-purple-700"><i class="bi bi-stars mr-1"></i>${aiText}</p>
                  </div>
                ` : ''}
                <div id="entrega-info-${m.id}" class="entrega-info"></div>
                ${isImage ? `
                  <button onclick="analyzeEntrega(${m.id})" id="btn-analyze-${m.id}" class="w-full mt-2 flex items-center justify-center gap-2 px-3 py-2 text-xs font-medium text-emerald-700 bg-emerald-50 hover:bg-emerald-100 rounded-lg transition-colors border border-emerald-200">
                    <i class="bi bi-search"></i>
                    <span>Extrair Detalhes (OCR)</span>
                  </button>
                ` : ''}
              </div>
            </div>`;
        }).join('');
      } catch (err) {
        gallery.innerHTML = `
          <div class="col-span-full text-center py-12 text-red-400">
            <i class="bi bi-exclamation-circle text-3xl"></i>
            <p class="mt-2">Erro ao carregar entregas: ${err.message}</p>
          </div>`;
      }
    }

    function openLightbox(src, caption) {
      document.getElementById('lightbox-img').src = src;
      document.getElementById('lightbox-caption').textContent = caption;
      document.getElementById('lightbox').classList.remove('hidden');
    }

    function closeLightbox(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('lightbox').classList.add('hidden');
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeLightbox();
    });

    async function analyzeEntrega(msgId) {
      const btn = document.getElementById('btn-analyze-' + msgId);
      if (!btn) return;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i> <span>Analisando...</span>';

      try {
        const data = await Shared.api(`/api/whatsapp/messages/${msgId}/analyze-entrega`, { method: 'POST' });
        const info = data.entrega;
        const infoEl = document.getElementById('entrega-info-' + msgId);
        if (infoEl && info) {
          let html = '<div class="space-y-1 p-2 bg-gray-50 rounded-lg border border-gray-200">';
          if (info.destinatario) html += `<div class="flex items-center gap-2 text-xs"><i class="bi bi-person text-blue-500"></i><span class="text-gray-500">Para:</span><span class="font-medium">${info.destinatario}</span></div>`;
          if (info.remetente) html += `<div class="flex items-center gap-2 text-xs"><i class="bi bi-send text-green-500"></i><span class="text-gray-500">De:</span><span class="font-medium">${info.remetente}</span></div>`;
          if (info.transportadora) html += `<div class="flex items-center gap-2 text-xs"><i class="bi bi-truck text-orange-500"></i><span class="text-gray-500">Transp.:</span><span class="font-medium">${info.transportadora}</span></div>`;
          if (info.descricao) html += `<div class="text-xs text-gray-600 mt-1">${info.descricao}</div>`;
          html += '</div>';
          infoEl.innerHTML = html;
        }
        btn.innerHTML = '<i class="bi bi-check-lg"></i> <span>Analisado</span>';
        btn.classList.remove('text-emerald-700', 'bg-emerald-50', 'hover:bg-emerald-100', 'border-emerald-200');
        btn.classList.add('text-gray-500', 'bg-gray-50', 'border-gray-200');
      } catch (err) {
        btn.innerHTML = '<i class="bi bi-exclamation-circle"></i> <span>Erro</span>';
        Shared.showToast('Erro ao analisar: ' + err.message, 'danger');
      } finally {
        btn.disabled = false;
      }
    }

    window.onAuthReady = function(user) {
      if (user.role !== 'admin') {
        window.location.href = '/dashboard.html';
        return;
      }
      loadEmployees();
      loadEntregas();
    };
  </script>
</body>
</html>
